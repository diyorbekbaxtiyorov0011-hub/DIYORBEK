<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Supercars | Full-Stack 3D</title>
    <style>
        :root { --p-green: #2ecc71; --dark: #050505; --glass: rgba(255, 255, 255, 0.05); }
        body { margin: 0; background: var(--dark); color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; }
        #canvas-container { width: 100vw; height: 100vh; position: relative; }
        
        /* UI Dizayn */
        .glass-ui {
            position: absolute; background: var(--glass);
            backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px; padding: 25px; z-index: 100;
        }

        .side-panel { top: 50%; left: 30px; transform: translateY(-50%); width: 260px; border-left: 4px solid var(--p-green); }
        .admin-panel { bottom: -450px; left: 50%; transform: translateX(-50%); width: 85%; height: 320px; transition: 0.6s cubic-bezier(0.4, 0, 0.2, 1); display: flex; gap: 30px; }
        .admin-panel.active { bottom: 30px; }

        .btn {
            background: var(--p-green); color: #000; border: none; padding: 12px;
            border-radius: 8px; cursor: pointer; font-weight: 700; width: 100%;
            text-transform: uppercase; font-size: 11px; transition: 0.3s; margin-top: 10px;
        }
        .btn:hover { box-shadow: 0 0 20px var(--p-green); transform: translateY(-2px); }

        h2 { margin: 0 0 10px 0; font-size: 20px; color: var(--p-green); }
        .stat { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        input { background: #000; color: var(--p-green); border: 1px solid #333; padding: 8px; width: 90%; margin-bottom: 5px; border-radius: 4px; }
        .admin-toggle { position: absolute; bottom: 30px; right: 30px; z-index: 101; cursor: pointer; font-size: 24px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="canvas-container">
        <div class="glass-ui side-panel">
            <h2 id="display-name">YUKLANMOQDA...</h2>
            <div class="stat">POWER: <span id="display-power" style="color:white">---</span></div>
            <div class="stat">SPEED: <span id="display-speed" style="color:white">---</span></div>
            <hr style="border: 0.5px solid #222; margin: 15px 0;">
            <button class="btn" onclick="window.loadNextCar()">KEYINGI MODEL ➔</button>
        </div>

        <div class="admin-toggle" onclick="document.getElementById('adminPanel').classList.toggle('active')">⚙️</div>

        <div class="glass-ui admin-panel" id="adminPanel">
            <div style="flex: 1;">
                <h3 style="color: var(--p-green); margin-top: 0;">YANGI MASHINA</h3>
                <input type="text" id="db-name" placeholder="Nomi (Lambo...)">
                <input type="text" id="db-url" placeholder="Fayl nomi (.glb)">
                <input type="text" id="db-power" placeholder="Ot kuchi (800 HP)">
                <input type="text" id="db-speed" placeholder="Tezlik (350 KM/H)">
                <button class="btn" onclick="window.saveToFirebase()">BAZAGA SAQLASH</button>
            </div>
            <div style="flex: 1; border-left: 1px solid #333; padding-left: 25px;">
                <h3 style="color: var(--p-green); margin-top: 0;">SAHNA SOZLAMALARI</h3>
                <label style="font-size: 12px;">CHIROQ KUCHI</label>
                <input type="range" min="0" max="200" value="100" oninput="window.updateLight(this.value)">
                <label style="display:block; margin-top:10px;"><input type="checkbox" checked onchange="window.controls.autoRotate = this.checked"> AUTO-ROTATE</label>
                <p style="font-size: 10px; color: #555; margin-top: 20px;">FIREBASE STATUS: CONNECTED ✓</p>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // ==========================================================
        // 1. DIQQAT! NUSXALAGAN KODINGIZNI SHU YERGA QO'YING:
        const firebaseConfig = {
            apiKey: "AIzaSyD2ZyeDAT517538fSljJ581d9yohZ3Td1c", 
            authDomain: "portfolio-f332d.firebaseapp.com",
            projectId: "portfolio-f332d",
            storageBucket: "portfolio-f332d.firebasestorage.app",
            messagingSenderId: "327196596703",
            appId: "1:327196596703:web:c8e7bafc0f18bf71b3cc6a"
        };
        // ==========================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let scene, camera, renderer, controls, carModel, neonLight;
        let dbCars = [];
        let currentIndex = 0;

        async function init() {
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.08);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(-6, 3, 8);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            neonLight = new THREE.SpotLight(0x2ecc71, 150);
            neonLight.position.set(5, 10, 5);
            scene.add(neonLight);
            scene.add(new THREE.AmbientLight(0xffffff, 0.2));

            const grid = new THREE.GridHelper(50, 50, 0x2ecc71, 0x050505);
            grid.position.y = -1.2;
            scene.add(grid);

            window.controls = new OrbitControls(camera, renderer.domElement);
            window.controls.enableDamping = true;
            window.controls.autoRotate = true;

            await fetchFromFirebase();
            animate();
        }

        async function fetchFromFirebase() {
            try {
                const querySnapshot = await getDocs(collection(db, "cars"));
                dbCars = querySnapshot.docs.map(doc => doc.data());
                if(dbCars.length > 0) displayCar(0);
                else {
                    document.getElementById('display-name').innerText = "BAZA BO'SH";
                }
            } catch (e) { console.error("Firebase Xatosi:", e); }
        }

        function displayCar(index) {
            const data = dbCars[index];
            document.getElementById('display-name').innerText = data.name;
            document.getElementById('display-power').innerText = data.power || "N/A";
            document.getElementById('display-speed').innerText = data.speed || "N/A";
            
            if(carModel) scene.remove(carModel);
            const loader = new GLTFLoader();
            loader.load(data.modelUrl, (gltf) => {
                carModel = gltf.scene;
                carModel.traverse(n => {
                    if(n.isMesh && n.name.toLowerCase().includes('body')) {
                        n.material.color.set(0x013220);
                    }
                });
                carModel.scale.set(3, 3, 3);
                carModel.position.y = -1.2;
                scene.add(carModel);
            });
        }

        window.saveToFirebase = async () => {
            const newCar = {
                name: document.getElementById('db-name').value,
                modelUrl: document.getElementById('db-url').value,
                power: document.getElementById('db-power').value,
                speed: document.getElementById('db-speed').value
            };
            await addDoc(collection(db, "cars"), newCar);
            alert("Saqlandi!");
            fetchFromFirebase();
        };

        window.loadNextCar = () => {
            if(dbCars.length === 0) return;
            currentIndex = (currentIndex + 1) % dbCars.length;
            displayCar(currentIndex);
        };

        window.updateLight = (v) => { neonLight.intensity = v; };

        function animate() {
            requestAnimationFrame(animate);
            window.controls.update();
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        init();
    </script>
</body>
</html>
