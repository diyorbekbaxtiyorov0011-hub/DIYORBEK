<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Luxury Store | Admin & Wallet</title>
    <style>
        :root { --gold: #d4af37; --dark: #0a0a0a; --glass: rgba(255,255,255,0.03); }
        body { margin: 0; background: var(--dark); color: white; font-family: 'Orbitron', sans-serif; overflow-x: hidden; }
        
        /* Navbar */
        nav {
            position: fixed; top: 0; width: 100%; padding: 20px 50px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 1000;
            box-sizing: border-box; border-bottom: 1px solid rgba(212, 175, 55, 0.2);
        }

        .user-info { display: flex; align-items: center; gap: 15px; }
        .balance { color: var(--gold); font-weight: bold; border: 1px solid var(--gold); padding: 5px 15px; border-radius: 20px; }
        .user-img { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--gold); }

        /* Main 3D Stage */
        #canvas-container { width: 100vw; height: 70vh; margin-top: 80px; }

        /* Store Section */
        .store-container { padding: 50px; display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }
        .card {
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            padding: 20px; border-radius: 15px; text-align: center; transition: 0.3s;
        }
        .card:hover { transform: translateY(-10px); border-color: var(--gold); box-shadow: 0 10px 30px rgba(212,175,55,0.1); }
        .price { font-size: 24px; color: var(--gold); margin: 15px 0; }

        /* Buttons */
        .btn-gold {
            background: var(--gold); color: black; border: none; padding: 12px 25px;
            border-radius: 5px; cursor: pointer; font-weight: bold; text-transform: uppercase; width: 100%;
        }
        .btn-login { background: white; color: black; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* Admin Panel Modal */
        #admin-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 2000; padding: 50px;
        }
        .admin-form { max-width: 500px; margin: auto; background: #111; padding: 30px; border-radius: 15px; border: 1px solid var(--gold); }
        input { width: 100%; padding: 12px; margin-bottom: 15px; background: #000; border: 1px solid #333; color: white; border-radius: 5px; box-sizing: border-box; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <nav>
        <div style="font-size: 20px; font-weight: bold; color: var(--gold);">LUXE 3D STORE</div>
        <div id="auth-section">
            <button class="btn-login" onclick="loginWithGoogle()">GOOGLE BILAN KIRISH</button>
        </div>
        <div id="user-section" class="user-info" style="display: none;">
            <div class="balance" onclick="topUpBalance()">HAMYON: <span id="user-balance">0</span> $</div>
            <img id="user-pfp" class="user-img" src="" alt="">
            <button id="admin-btn" style="display:none;" onclick="showAdmin()">ADMIN</button>
        </div>
    </nav>

    <div id="canvas-container"></div>

    <div class="store-container" id="product-list">
        </div>

    <div id="admin-modal">
        <div class="admin-form">
            <h2>YANGI MAHSULOT</h2>
            <input type="text" id="p-name" placeholder="Mahsulot nomi">
            <input type="text" id="p-price" placeholder="Narxi ($)">
            <input type="text" id="p-model" placeholder="3D Model Linki (.glb)">
            <button class="btn-gold" onclick="addProduct()">BAZAGA QO'SHISH</button>
            <button class="btn-gold" style="background:#333; color:white; margin-top:10px;" onclick="closeAdmin()">YOPISH</button>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 1. Firebase Config (O'zingiznikini qo'ying)
        const firebaseConfig = {
            apiKey: "AIzaSyD2ZyeDAT517538fSljJ581d9yohZ3Td1c", authDomain: "portfolio-f332d.firebaseapp.com", projectId: "portfolio-f332d", storageBucket: "portfolio-f332d.firebasestorage.app", messagingSenderId: "327196596703", appId: "1:327196596703:web:c8e7bafc0f18bf71b3cc6a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let scene, camera, renderer, controls, carModel;

        // --- AUTH MANTIQI ---
        window.loginWithGoogle = () => {
            signInWithPopup(auth, provider).then(async (result) => {
                const user = result.user;
                // Foydalanuvchini bazada tekshirish/yaratish
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, { name: user.displayName, balance: 0, role: 'user' });
                }
                location.reload();
            });
        };

      onAuthStateChanged(auth, async (user) => {
    if (user) {
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('user-section').style.display = 'flex';
        document.getElementById('user-pfp').src = user.photoURL;
        
        // MAHSUS QATOR: Hozircha hamma kirgan odam admin bo'lsin
        document.getElementById('admin-btn').style.display = 'block'; 
        
        const userSnap = await getDoc(doc(db, "users", user.uid));
        if (userSnap.exists()) {
            document.getElementById('user-balance').innerText = userSnap.data().balance;
        }
    }
});

        // --- 3D SAHNA ---
        function init3D() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / (window.innerHeight*0.7), 0.1, 1000);
            camera.position.set(5, 2, 8);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight * 0.7);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0xffffff, 1));
            const pointLight = new THREE.PointLight(0xd4af37, 50);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.autoRotate = true;

            loadModel('free__lamborghini_terzo_millennio.glb'); // Asosiy model
            animate();
        }

        function loadModel(path) {
            const loader = new GLTFLoader();
            loader.load(path, (gltf) => {
                if(carModel) scene.remove(carModel);
                carModel = gltf.scene;
                carModel.scale.set(2.5, 2.5, 2.5);
                scene.add(carModel);
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // --- DO'KON MANTIQI ---
        async function fetchProducts() {
            const querySnapshot = await getDocs(collection(db, "products"));
            const list = document.getElementById('product-list');
            list.innerHTML = "";
            querySnapshot.forEach((doc) => {
                const p = doc.data();
                list.innerHTML += `
                    <div class="card">
                        <h3>${p.name}</h3>
                        <div class="price">${p.price} $</div>
                        <button class="btn-gold" onclick="buyProduct('${doc.id}', ${p.price})">SOTIB OLISH</button>
                    </div>
                `;
            });
        }

        window.addProduct = async () => {
            const p = {
                name: document.getElementById('p-name').value,
                price: Number(document.getElementById('p-price').value),
                modelUrl: document.getElementById('p-model').value
            };
            await addDoc(collection(db, "products"), p);
            alert("Mahsulot qo'shildi!");
            location.reload();
        };

        window.topUpBalance = () => {
            alert("Hamyonni to'ldirish uchun @admin_telegram ga yozing (Hozircha demo rejim)");
        };

        window.showAdmin = () => document.getElementById('admin-modal').style.display = 'block';
        window.closeAdmin = () => document.getElementById('admin-modal').style.display = 'none';

        init3D();
        fetchProducts();
    </script>
</body>
</html>
